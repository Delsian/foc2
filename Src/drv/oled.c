#include "drv/oled.h"
#include "main.h"
#include <string.h>

#define OLED_I2C_ADDR       (0x3C << 1)
#define OLED_WIDTH          128
#define OLED_HEIGHT         64
#define OLED_PAGES          (OLED_HEIGHT / 8)

static I2C_HandleTypeDef *oled_hi2c = NULL;

static uint8_t oled_buffer[OLED_WIDTH * OLED_PAGES];
static uint8_t oled_x = 0;
static uint8_t oled_y = 0;
static uint8_t oled_initialized = 0;

static const uint8_t font_12x16[][24] = {
    /* 0 */
    {0x00, 0xE0, 0xF8, 0x1C, 0x0E, 0x06, 0x06, 0x0E, 0x1C, 0xF8, 0xE0, 0x00,
     0x00, 0x0F, 0x3F, 0x70, 0xE0, 0xC0, 0xC0, 0xE0, 0x70, 0x3F, 0x0F, 0x00},
    /* 1 */
    {0x00, 0x00, 0x30, 0x18, 0x1C, 0xFE, 0xFE, 0x00, 0x00, 0x00, 0x00, 0x00,
     0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00},
    /* 2 */
    {0x00, 0x38, 0x1C, 0x0E, 0x06, 0x06, 0x06, 0x0E, 0x9C, 0xF8, 0x70, 0x00,
     0x00, 0xE0, 0xF0, 0xF8, 0xDC, 0xCE, 0xC7, 0xC3, 0xC1, 0xC0, 0xC0, 0x00},
    /* 3 */
    {0x00, 0x18, 0x0C, 0x0E, 0x86, 0x86, 0x86, 0xCE, 0xFC, 0x78, 0x00, 0x00,
     0x00, 0x30, 0x60, 0xE0, 0xC1, 0xC1, 0xC1, 0xE3, 0x7F, 0x3E, 0x00, 0x00},
    /* 4 */
    {0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18, 0xFE, 0xFE, 0x00, 0x00, 0x00,
     0x00, 0x0F, 0x0F, 0x0C, 0x0C, 0x0C, 0x0C, 0xFF, 0xFF, 0x0C, 0x0C, 0x00},
    /* 5 */
    {0x00, 0x00, 0xFE, 0xFE, 0xC6, 0xC6, 0xC6, 0xC6, 0x86, 0x06, 0x00, 0x00,
     0x00, 0x30, 0x61, 0xE1, 0xC1, 0xC1, 0xC1, 0xE3, 0x7F, 0x3E, 0x00, 0x00},
    /* 6 */
    {0x00, 0xE0, 0xF8, 0x9C, 0xCE, 0xC6, 0xC6, 0xC6, 0x8E, 0x1C, 0x00, 0x00,
     0x00, 0x0F, 0x3F, 0x71, 0xE1, 0xC1, 0xC1, 0xE1, 0x7F, 0x3F, 0x00, 0x00},
    /* 7 */
    {0x00, 0x06, 0x06, 0x06, 0x06, 0x06, 0x86, 0xE6, 0x7E, 0x1E, 0x06, 0x00,
     0x00, 0x00, 0x00, 0x00, 0xC0, 0xF8, 0x3F, 0x07, 0x00, 0x00, 0x00, 0x00},
    /* 8 */
    {0x00, 0x78, 0xFC, 0xCE, 0x86, 0x86, 0x86, 0xCE, 0xFC, 0x78, 0x00, 0x00,
     0x00, 0x3E, 0x7F, 0xE3, 0xC1, 0xC1, 0xC1, 0xE3, 0x7F, 0x3E, 0x00, 0x00},
    /* 9 */
    {0x00, 0xF8, 0xFC, 0x8E, 0x06, 0x06, 0x06, 0x0E, 0x9C, 0xF8, 0xE0, 0x00,
     0x00, 0x00, 0xE1, 0xC3, 0xC3, 0xC3, 0xE7, 0x7E, 0x3F, 0x0F, 0x01, 0x00},
    /* 10 - RPM icon (circular arrow) */
    {0x00, 0xE0, 0xF0, 0x38, 0x1C, 0x0E, 0x0E, 0x1C, 0x38, 0xF0, 0xE0, 0x00,
     0x00, 0x0F, 0x1F, 0x38, 0x70, 0xE0, 0xE0, 0x70, 0x38, 0x1F, 0x0F, 0x00},
    /* 11 - ANGLE icon (angle symbol) */
    {0x00, 0x00, 0x00, 0x80, 0xC0, 0x60, 0x30, 0x18, 0x0C, 0x06, 0xFE, 0x00,
     0x00, 0x00, 0xFE, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00}
};

static const uint8_t oled_init_seq[] = {
    0xAE,        // turn off oled panel
    0xD5, 0x80,  // set display clock divide ratio/oscillator frequency
    0xA8, 0x3F,  // set multiplex ratio (1/64 duty)
    0xD3, 0x00,  // set display offset (not offset)
    0x20, 0x00,  // horizontal addressing mode
    0xAD, 0x30,  // Internal IREF Setting
    0x8D, 0x14,  // set Charge Pump enable/disable
    0x68,        // set start line address
    0xA6,        // set normal display
    0xA4,        // Disable Entire Display On
    0xA1,        // set segment re-map 128 to 0
    0xC8,        // Set COM Output Scan Direction 64 to 0
    0xDA, 0x12,  // set com pins hardware configuration
    0x81, 0x7F,  // set contrast control register
    0xD9, 0x22,  // set pre-charge period
    0xDB, 0x40,  // set vcomh
    0xAF         // turn on oled panel
};

static int oled_send(uint8_t ctrl, const uint8_t *data, uint16_t len)
{
    uint8_t buf[len + 1];
    buf[0] = ctrl;
    memcpy(&buf[1], data, len);
    return HAL_I2C_Master_Transmit(oled_hi2c, OLED_I2C_ADDR, buf, len + 1, 100);
}

void oled_init(I2C_HandleTypeDef *hi2c)
{
    if (oled_initialized) {
        return;
    }

    oled_hi2c = hi2c;

    HAL_Delay(100);

    for (uint16_t i = 0; i < sizeof(oled_init_seq); i++) {
        oled_send(0x00, &oled_init_seq[i], 1);
    }

    oled_clear();
    oled_update();
    oled_initialized = 1;
}

void oled_clear(void)
{
    memset(oled_buffer, 0, sizeof(oled_buffer));
    oled_x = 24;
    oled_y = 0;
}

void oled_write(const char *str, uint8_t x, uint8_t y)
{
    oled_x = x + 28;
    oled_y = y;

    while (*str) {
        uint8_t glyph_idx = 0xFF;

        if (*str >= '0' && *str <= '9') {
            glyph_idx = *str - '0';
        } else if (*str == 'R') {
            glyph_idx = 10;  /* RPM icon */
        } else if (*str == 'A') {
            glyph_idx = 11;  /* ANGLE icon */
        }

        if (glyph_idx != 0xFF) {
            for (uint8_t i = 0; i < 12; i++) {
                uint16_t page0_idx = (oled_y * OLED_WIDTH) + oled_x + i;
                uint16_t page1_idx = ((oled_y + 1) * OLED_WIDTH) + oled_x + i;

                if (oled_x + i < OLED_WIDTH && oled_y < OLED_PAGES) {
                    oled_buffer[page0_idx] = font_12x16[glyph_idx][i];
                }
                if (oled_x + i < OLED_WIDTH && oled_y + 1 < OLED_PAGES) {
                    oled_buffer[page1_idx] = font_12x16[glyph_idx][i + 12];
                }
            }
            oled_x += 12;
        }
        str++;
    }
}

void oled_update(void)
{
    const uint8_t clr_seq[] = {0x21, 0x00, 0x7F, 0x22, 0x00, 0x07};
    oled_send(0x00, clr_seq, sizeof(clr_seq));

    for (int i = 0; i < 8; i++) {
        oled_send(0x40, &oled_buffer[128 * i], 128);
    }
}
